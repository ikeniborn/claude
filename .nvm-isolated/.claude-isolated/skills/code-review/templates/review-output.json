{
  "$comment": "Code review output template with Architecture Compliance, LSP diagnostics",
  "code_review": {
    "score": 75,
    "passed": false,
    "blocking_issues": [
      {
        "category": "architecture_compliance",
        "severity": "BLOCKING",
        "rule": "circular_dependency",
        "cycle_path": "cli-main → proxy-management → credential-storage → cli-main",
        "message": "Circular dependency detected in architecture",
        "suggestion": "Break cycle using dependency injection or mediator pattern"
      },
      {
        "category": "architecture_compliance",
        "severity": "BLOCKING",
        "rule": "layer_violation",
        "component": "credential-storage",
        "layer": "infrastructure",
        "depends_on": "oauth-token-management",
        "depends_on_layer": "core",
        "message": "Layer violation: infrastructure depends on core (upward dependency)",
        "suggestion": "Move component or introduce adapter pattern"
      },
      {
        "category": "security",
        "severity": "BLOCKING",
        "file": "src/api/users.py",
        "line": 42,
        "message": "Potential SQL injection vulnerability",
        "suggestion": "Use parameterized query instead of string concatenation",
        "code_snippet": "query = f\"SELECT * FROM users WHERE email = '{email}'\""
      }
    ],
    "warnings": [
      {
        "category": "code_quality",
        "severity": "WARNING",
        "file": "src/service.py",
        "line": 65,
        "message": "Function too long (72 lines)",
        "suggestion": "Extract helper methods to reduce complexity"
      },
      {
        "category": "type_safety",
        "severity": "WARNING",
        "file": "src/models.py",
        "line": 15,
        "message": "Missing type hint for function parameter",
        "suggestion": "Add type hint: def process_data(data: dict) -> None"
      }
    ],
    "suggestions": [
      "Consider adding docstrings to public functions",
      "Use constants instead of magic numbers",
      "Consider documenting new function at iclaude.sh:3850-3900"
    ],
    "lsp_diagnostics": [
      {
        "$comment": "Optional field - only present when lsp_status.status == 'READY'",
        "source": "pyright",
        "severity": "error",
        "file": "src/service.py",
        "line": 45,
        "column": 12,
        "message": "Type 'str' is not assignable to type 'int'",
        "code": "TS2322",
        "suggestion": "Add parseInt() conversion or change type annotation"
      },
      {
        "source": "vtsls",
        "severity": "warning",
        "file": "frontend/app.ts",
        "line": 23,
        "column": 5,
        "message": "Variable 'unusedVar' is declared but never used",
        "code": "TS6133",
        "suggestion": "Remove unused variable or prefix with underscore"
      }
    ],
    "metrics": {
      "architecture_compliance": {
        "score": 5,
        "max": 25,
        "issues": 2,
        "checks_run": [
          "referential_integrity",
          "circular_dependencies",
          "component_validation",
          "layer_boundaries"
        ],
        "scope": {
          "modified_components": ["validate-proxy-url"],
          "dependent_components": ["proxy-management", "cli-main"],
          "total_checked": 3
        }
      },
      "security": {
        "score": 15,
        "max": 25,
        "issues": 1
      },
      "code_quality": {
        "score": 20,
        "max": 25,
        "issues": 1
      },
      "error_handling": {
        "score": 15,
        "max": 15,
        "issues": 0
      },
      "type_safety": {
        "score": 5,
        "max": 10,
        "issues": 3,
        "$comment": "Includes 2 LSP diagnostics (if available)"
      }
    },
    "files_reviewed": [
      "src/api/users.py",
      "src/service.py",
      "src/models.py",
      "frontend/app.ts",
      "iclaude.sh"
    ],
    "lsp_available": true,
    "architecture_available": true,
    "$comment": [
      "lsp_available: true когда lsp_status.status == 'READY'",
      "architecture_available: true когда docs/architecture/overview.yaml существует и yq/jq доступны",
      "Score calculation: architecture(25%) + security(25%) + code_quality(25%) + error_handling(15%) + type_safety(10%)",
      "Если architecture_available: false, веса пересчитываются: security(33.33%) + code_quality(33.33%) + error_handling(20%) + type_safety(13.33%)"
    ]
  }
}
